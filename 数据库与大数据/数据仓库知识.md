### 维度设计

#### 维度设计基础

维度使用主键标识其唯一性，主键也是确保与之相连的任何事实表之间存在引用完整性的基础。维度表一般由代理键、自然键、维度属性三部分构成。

| 名称     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 代理键   | 不具有任何业务含义，仅做维度表数据唯一性区分的属性，通常以主键形式出现。 |
| 自然键   | 具有业务含义，是业务实体一个实例的唯一性区分，在维度表中不一定做表的主键。如身份证号 |
| 维度属性 | 描述同一业务实体各种特征的维度列                             |
| 固化属性 | 和维度实体关系相对紧密且较为稳定的固有属性，不依赖或很少依赖于其它的业务活动过程 |
| 动态属性 | 只能基于特定的事务过程或者活动关联，在维度实体的层次上汇总得到的一些统计属性。 |

维度表的主键一般都取整型值的标志列类型，这样也是为了节省事实表的存储空间。维度表的维度属性一般可以分为相对稳定的固化属性和变动频繁动态属性。

##### 维度的基本设计方法

维度的设计过程就是确定维度属性的过程，下面以淘宝的商品维度为例对维度设计方法进行详细说明。

第一步：选择维度或新建维度。作为维度建模的核心，在数据仓库中必须保证维度的唯一性。以淘宝商品维度为例，有且只允许有 一个维度定义。

第二步：确定主维表。此处的主维表一般是`ODS`表，直接与业务系统同步。以淘宝商品维度为例， `s_auction_ auctions` 是与前台商品中心系统同步的商品表，此表即是主维表。 

第三步：确定相关维表。根据对业务的梳理，确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。以淘宝商品维度为例，根据对业务逻辑的梳理，可以得到商品与类目、 `SPU`卖家、店铺等维度存在关联关系。

 第四步 ：确定维度属性。本步骤主要包括两个阶段，其中第一个阶段是从主维表中选择维度属性或生成新的维度属性；第二个阶段是从相关维表中选择维度属性或生成新的维度属性。以淘宝商品维度为例，从主维表`s_auction_auctions`和类目、 `SPU` 、卖家、店铺等相关维表中选择维度属性或生成新的维度属性。

确定维度属性的几点提示：①尽可能生成丰富的维度属性；②尽可能多地给出包括一些富有意义的文字性描述属性不应该是编码，一般是编码和文字同时存在；③区分数值型属性和事实；④尽量沉淀出通用的维度属性。

##### 一致性维度和交叉探查

存在很多需求是对于不同数据域的业务过程或者同一数据域的不同业务过程合并在一起观察。比如对于日志数据域，统计了商品维度的最近一天的`PV`和`UV`；对于交易数据域，统计了商品维度的最近一天的下单`GMV`。现在将不同数据域的商品事实合并在一起进行数据探查，如计算转化率，称为交叉探查。

维度不一致的情况包括：当存在重复的维度，但维度属性或维度属性的值不一致时，会导致交叉探查无法进行或交叉探查结果错误。维度格式不一致（如一个时间格式为：`yyyy-MM-dd HH:mm:ss`，另一个是`UNIX` `timestamp`）和内容不一致两种形式

维度一致性原则主要体现在三个方面：结构一致性、语意一致性、内容一致性。 

| 名称     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 结构一致 | 同一实体的同一维度属性在不同维度表/事实表中，需有相同的维度属性列名、相同的数据类型定义，以保证内容的同一性 |
| 语意一致 | 不同维度表/事实表中，相同维度属性所表达的业务含义需要是一致，否则在使用过程中会出现相同指标、不同结果的数据指标不一致性 |
| 内容一致 | 是需要在同一实体同一维度属性在不同维度表中需要有相同的数据内容表示（如下单日期维度和支付日志维度中month属性一个是‘2020-02’，一个‘02’） |

保证一致性的两个方法：共享维度表结构：同一实体的不同角色维度表共享一张维度表，通过在核心维度表上创建视图或进行数据导出实现维度表结构的共享；共享维度表内容：其他表加工过程中使用到维度属性内容，直接从维度表中获取，该实体的所有属性，均以维度表中属性为准，仅在维度表中进行维护，其他事实表/维度表中使用到维度表的指定属性，仅做内容共享。

#### 维度设计高级主题

##### 维度整合

数据仓库的重要数据来源是大量的、分散的面向应用的操作型环境。应用之间的差异具体表现在如下几个方面：

- 应用在编码、命名习惯、度量单位等方面存在很大的差异。
- 应用处于性能和扩展性的考虑，或者随技术架构的演变，以及业务的发展，采用不同的物理实现。拆分至不同类型数据库中，部分数据采用关系型数据库存储，部分数据采用`NoSQL`数据库存储。拆分成同一类型数据库中的多个物理表，比如对于淘宝商品，有商品主表和商品扩展表，商品主表存储商品基本信息，商品扩展表存储商品特 殊信息。

将面向应用的数据转换为面向主题的数据仓库数据，本身就是一 种集成。具体体现在如下几个方面：①命名规范的统一。表名、字段名等统一；②字段类型的统一，相同和相似字段的字段类型统一；③公共代码及代码值的统一，公共代码及标志性宇段的数据类型、 命名方式等统一。

业务含义相同的表的统一，在物理实现中，将业务关系大、源系统影响差异小的表进行整合： 将业务关系小、源系统影响差异大的表进行分而置之。通常有如 下几种集成方式： 

〉采用主从表的设计方式，将两个表或多个表都有的字段放在主表中，从属信息分别放在各自的从表中。 对于主表中的主键，要么采用复合主键、源主键和系统或表区别标志；要么采用唯一主键、“源主键和系统或表区别标志” 生成新的主键。通常建议采用复合主键的方式。 

直接合并，共有信息和个性信息都放在同一个表中。如果表字段的重合度较低，则会出现大量空值，对于存储和易用性会有影响。

不合并，因为源表的表结构及主键等差异很大，无法合并， 使用数据仓库里的多个表存放各自的数据。

维表的整合涉及的内容和上面介绍的几个方面相同，下面重点看表级别的整合，有两种表现形式。 

第一种是垂直整合，即不同的来源表包含相同的数据集，只是存储的信息不同。比如淘宝会员在源系统中有多个表，如会员基础信息表、 会员扩展信息表、淘宝会员等级信息表、天猫会员等级信息表，这些表都属于会员相关信息表，依据维度设计方法，尽量整合至会员维度模型中，丰富其维度属性。

 第二种是水平整合，即不同的来源表包含不同的数据集，不同子集之间无交叉，也可以存在部分交叉。一种方式是设置超自然键，将来源表各子集的自然键加工成一个字段作为超自然键。在阿里巴巴，通常采用将来源表各子集的自然键作为联合主键的方式，并且在物理实现时将来源字段作为分区字段。

##### 水平拆分

以客户维度来说，银行客户包括对公客户和对私客户，客户之间除了公共属性之外，还存在各自的特有属性，对于这种情况又两种处理方式：①将维度的不同分类实例化为不同的维度，同时在主维度表保存公共属性；②维护单一维度，包含所有可能的属性。选择哪种方案需要考虑的因素会有很多，重点考虑以下三个原则：扩展性，当源系统或业务逻辑变化时，能通过较少的成本快速拓展模型，保持核心模型的相对稳定性；效能，在性能和成本方面取得平衡；易用性，模型可理解性高、访问复杂度低。

根据数据模型设计思想，在对维度进行水平拆分时，主要考虑以下两个依据：①维度的不同分类的属性差异情况，当维度属性随类型变化较大时，将所有的属性建立一个表是不切实际的，也没有必要，建议采用①；②业务的关联程度。两个相关性较低的业务，耦合在一起弊大于利，对模型的稳定性和易用性影响较大。

##### 垂直拆分

在进行维度设计时，依据 维度设计的原则，尽可能丰富维度属性，同时进行反规范化处理。对于具体实现时可能存在的问题，一是在“水平拆分”中提到的，由于维度分类的不同而存在特殊的维度属性，可以通过水平拆分的方式解决此问题。 二是某些维度属性的来源表产出时间较早，而某些维度属性的来源表产出时间较晚；或者某些维度属性的热度高、使用频繁，而某些维度属性的热度低、较少使用或者某些维度属性经常变化，而某些维度属性比较稳定。在“水平拆分”中提到的模型设计的三个原则同样适合解决此问题。 出于扩展性、产出时间、易用性等方面的考虑，设计主从维度。主 维表存放稳定 产出时间早、热度高的属性；从维表存放变化较快、产 出时间晚、热度低的属性

#### 维度变化

##### 缓慢变化维度

缓慢变化维的提出是因为在现实世界中，维度的属性并不是静态的，它会随着时间的流逝发生缓慢的变化与数据增长较为快速的事实表相比，维度变化相对缓慢。

第一种处理方式 ：重写维度值。采用此种方式，不保留历史数据， 始终取最新数据。比如，商品所属的类目于 2015年11月16 日由类目1变成类目2，采用第1种处理方式，变化前后的数据记录

![](../picture/2/323.png)

![](../picture/2/324.png)

第二种处理方式：插入新的维度行。采用此种方式，保留历史数据，维度值变化前的事实和过去的纬度值关联，纬度值变化后的事实和当前的纬度值关联

![](../picture/2/325.png)

第三种处理方式：添加维度列。采用第 种处理方式不能将变化前后记录的事实归一为变化前的维度或者归一为变化后的维度。比如根据业务需求，需要将11月份的交易金额全部统计到类目2上，采用第二种处理方式无法实现。

![](../picture/2/326.png)

![](../picture/2/327.png)

##### 快照维度

数据仓库实践中，处理缓慢变化维的方法是采用快照方式。数据仓库的计算周期一般是每天一次，基于此周期，处理维度变化的方式就是每天保留一份全量快照数据。比如商品维度，每天保留一份全量商品快照数据。任意一天的事实均可以获取到当天的商品信息 ，也可以获取到最新的商品信息，通过限定日期，采用自然键进行关联即可。此方法优点主要有以下两点： 简单而有效，开发和维护成本低。 使用方便，理解性好。数据使用方只需要限定日期，即可获取到当天的快照数据。任意一天的事实快照和维度快照通过维度的自然键进行关联即可。

 弊端主要体现在存储的极大浪费上。比如某维度，每天的变化量占总体数据量的比例很低，在极端情况下，每天无变化，使得存储浪费很 严重。此方法主要就是实现了牺牲存储获取`ETL`效率的优化和逻辑上的简化。

##### 极限存储

首先来看历史拉链存储。历史拉链存储是指利用维度模型中缓慢变 化维的第二种处理方式。这种处理方式是通过新增两个时间戳字段 (sta rt_dt和end_dt ），将所有以天为粒度的变更数据都记录下来。通常 分区字段也是时间戳字段。

##### 微型维度

 通过将一些属性从维表中移出，放置到全新的维表中，可以解决维度的过度增长导致极限存储效果大打折扣的问题。其中一种解决方法就垂直拆分，保持主维度的稳定性；另一种解决方式是采用微型维度。 微型维度的创建是通过将一部分不稳定的属性从主维度中移出，并将它们放置到拥有自己代理键的新表中来实现的。这些属性相互之间没有直接关联，不存在自然键。通过为每个组合创建新行的一次性过程来加载数据。比如淘宝用户维度，用户的注册日期、年龄、 性别、身份信息基本不会发生变化，但用户`VIP`等级、用户信用评级等级会随着用户的行为不断发生变化。

![](../picture/2/328.png)

微型维度存在`ETL`加工逻辑复杂，破坏维度的可浏览性等问题，实际中很少使用。

#### 特殊维度

##### 递归层次

降低递归层次使用复杂度的最简单和有效的方法是层次结构的扁平化，通过建立维度的固定数量级别的属性来实现，可以在一定程度上解决上钻和下钻的问题。对于均衡层次结构，采用扁平化最有效。

针对层次结构扁平化所存在的问题，可以采用桥接表的方式来解决，不需要预先知道所属层级，不需要回填，也可解决非均衡层次结构 的问题。与扁平化方法相比，该方法适合解决更宽泛的分析问题，灵活 性好；但复杂性高，使用成本高。

###### 行为维度

按照加工方式，行为维度可以划分为以下几种： ①另一个维度 的过去行为，如买家最近一次访问淘宝的时间、 买家最近一次发生淘宝交易的时间等；②快照事实行为维度，如买家从年初截至当前的淘宝交易金额、买家信用分值 、卖家信用分值等；③分组事实行为维度 ，将数值型事实转换为枚举值。如买家从年初 截至当前的淘宝交易金额按照金额划分的等级、买家信用分值按 照分数划分得到的信用等级等；④复杂逻辑事实行为维度，通过复杂算法加工或多个事实综合加工 得到。如前面提到的卖家主营类目，商品热度根据访问、收藏、 加人购物车、交易等情况综合计算得到。

对于行为维度，有两种处理方式，其中一种是将其冗余至现有的维 表中，如将卖家信用等级冗余至卖家维表中 另一种是 工成单独的行 为维表，如卖家主营类目。具体采用哪种方式主要参考如下两个原则：第一 ，避免维度过快增长。比如对商品表进行了极限存储，如果将 商品热度加入现有的商品维表中，则可能会使每日商品变更占比过高， 从而导致极限存储效果较差。 第二，避免稠合度过高。 比如卖家主营类目，加工逻辑异常复杂， 如果融合进现有的卖家维表中，那么过多的业务稠合会导致卖家维表刷 新逻辑复杂、维护性差、产出延迟等。

###### 多值维度

对于多值维度， 一种情况是事实表的 条记录在某维表中有多条记录与之对应。比如对于淘宝交易订单，买家一次购买了多种商品，如一件毛衣和两双袜子，称为交易父订单 对于每种商品的交易，称为交易子订单：此交易父订单有两个子订单与之对应。假设设计交易父订单事 实表，则对于此事实表的每一条记录，在商品表中都有一到多条记录与 之对应。

针对多值维度，常见的处理方式有三种，可以根据业务的表现形式和统计分析需求进行选择。 

第一种处理方式是降低事实表的粒度。在淘宝交易中，前台业务和商业智能关注交易子订单 ，所以在数据仓库模型设计中，将交易订单设计为子订单粒度，对于每个子订单，只有一种商品与之对应。对于其 的事实，则采用分摊到子订单的方式来解决。但很多时候，事实表的粒度是不能降低的，多值维度的出现是无法避免的。

 第二种处理方式是采用多字段。比如房地产销售，每次合同签订都可能存在多个买受方的情况，如夫妻合买等。对于合同签订事实表， 每条记录可能对应多个买受方，而合同已经是此事实中的最细粒度 ，无法通过降低粒度的方式来解决。由于合同签订的买受人 般不会太多， 所以一般采用多字段方式。考虑到扩展性，可以通过预留字段的方式。

第三种处理方式是采用较为通用的桥接表。桥接表方式更加灵活、 扩展性更好，但逻辑复杂、开发和维护成本较高，可能带来双重计算的风险，选择此方式需慎重。通过在事实表和维表之间开发一个分组表， 通过此分组表建立连接。

###### 多值属性

维表中的某个属性字段同时有多个值，称之为多值属性。对于多值属性，常见的处理方式有三种，可以根据具体情况进行选择。 

第一种处理方式是保持维度主键不变，将多值属性放在维度的一个属性字段中。比如对于商品属性，可以通过 k-v 对的形式放在 property 段中。此种处理方式扩展性好，但数据使用较为麻烦；

第二种处理方式也是保持维度主键不变，但将多值属性放在维度的多个属性字段中。比如卖家主营类目，由于卖家店铺中可能同时会销售 男装、女装、内衣等，所以卖家主营类目可能有多个，但业务需求是只取根据算法计算得到的`TOP3 `。针对此种情况，维度的多值属性字段具体值的数量固定，可以采用多个属性字段进行存储，方便数据统计分析 和报表展示。如果多值属性字段具体值的数量不固定，则可以采用预留字段的方式，但扩展性较差；

第三种处理方式是维度主键发生变化， 个维度值存放多条记录。 比如商品`SKU`维表，对于每个商品，有多少`SKU`，就有多少记录，主键是商品的`ID`和`SKU ID`。此种处理方式扩展性好，使用方便，但需要考虑数据的急剧膨胀情况。比如淘宝商品属性表采用了此种处理方式，数据记录达到几百亿的级别。

###### 杂项维度

杂项维度是由操作型系统中的指示符或者标志宇段组合而成 的，一般不在一致性维度之列。比如淘宝交易订单的交易类型宇段，包括话费充值、司法拍卖、航旅等类型；支付状态、物流状态等，它们在源系统中直接保存在交易表中。

一个事实表中可能会存在多个类似的字段，如果作为事实存放在事实表中，则会导致事实表占用空间过大，如果单独建立维表，外键关联到事实表，则会出现维度过多的情况；如果将这些字段删除，则会有人 不同意。 

这时，通常的解决方案就是建立杂项维度 ，将这些字段建立到维表中，在事实表中只需保存一个外键即可。多个字段的不同取值组成 一条记录，生成代理键，存人维表中，并将该代理键保存到相应的事实 表字段下。

建议不要直接使用所有的组合生成完整的杂项维表，在抽取遇到新的组合时生成相应的记录即可。

### 事实表设计

| 名称           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 事务事实表     | 用于承载事务数据，通常粒度比较低，它是面向事务的，其粒度是每一行对应一个事务，它是最细粒度的事实表，例如产品交易事务事实、ATM交易事务事实 |
| 周期快照事实表 | 按照一定的时间周期间隔来捕捉业务活动的执行情况，一旦装入事实表就不会再去更新，它是事务事实表的补充。用来记录有规律的、固定时间间隔的业务累计数据，通常粒度比较高，例如账户月平均余额事实表 |
| 累积快照事实表 | 用来表述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点。当累积快照事实表随着生命周期不断变化时，记录也会随着过程的变化而被修改。 |

#### 事实表基础

##### 事实表特性

事实表作为数据仓库维度建模的核心，紧紧围绕着业务过程来设计，通过获取描述业务过程的度量来表达业务过程，包含了引用的维度和与业务过程有关的度量。 

事实表中一条记录所表达的业务细节程度被称为粒度。通常粒度可以通过两种方式来表述：一种是维度属性组合所表示的细节程度；一种是所表示的具体业务含义。 

作为度量业务过程的事实，一般为整型或浮点型的十进制数值，有可加性、半可加性和不可加性三种类型。可加性事实是指可以按照与事 实表关联的任意维度进行汇总；半可加性事实只能按照特定维度汇总， 不能对所有维度汇总，比如库存可以按照地点和商品进行汇总，而按时间维度把一年中每个月的库存累 加起来则毫无意义。还有一种度量完全不具备可加性，比如比率型事实。对于不可加性事实可分解为可加的组件来实现聚集。 

维度属性也可以存储到事实表中，这种存储到事实表中的维度列被 称为“退化维度”。

##### 事实表设计原则

尽可能包含所有与业务过程相关的事实。事实表设计的目的是为了度量业务过程，所以分析哪些事实与业务过程有关是设计中非常重要的关注点。

只选择与业务过程相关的事实。在选择事实时，应该注意只选择与业务过程有关的事实。比如在订单的下单这个业务过程的事实表设计中 ，不应该存在支付金额这个表示支付业务过程的事实。

分解不可加性事实为可加的组件。对于不具备可加性条件的事实，需要分解为可加的组件。

在选择维度和事实之前必须先声明粒度。粒度的声明是事实表设计中不可忽视的重要一步，粒度用于确定实表中一行所表示业务的细节层次，决定了维度模型的扩展性，在选择维度和事实之前必须先声明粒度，且每个维度和事实必须与所定义的粒度保持一致。

 在同一个事实表中不能有多种不同粒度的事实。事实表中的所有事实需要与表定义的粒度保持一致，在同一个事实表中不能有多种不同粒度的事实。

事实的单位要保持一致。对于同一个事实表中事实的单位，应该保持一致。

对事实的`null`值要处理。对于事实表中事实度量为`null`值的处理，因为在数据库中 `null`对过滤条件都不生效，比如大于、小于等，建议用零值填充。 

使用退化维度提高事实表的易用性 。在大数据领域的事实表设计中，则大量采用退化维度的方式，在事实表中存储各种类型的常用维度信息。这样设计的目的主要是为了减少下游用户使用时关联多个表的操作，直接通过退化维度实现对事实表的过滤查询、控制聚合层次、排序数据以及定义主从关系等。 通过增加冗余存储的方式减少计算开销，提高使用效率。

##### 事实表设计方法

业务过程可以概括为一个个不可拆分的行为事件。为理清数据之间的逻辑关系和流向，首先需要理解用户的业务过程，了解过程中涉及到的数据系统。每个业务会生成哪些数据，存在于什么数据库中；对业务过程进行分解，了解过程中的每一个环节会产生哪些数据，数据的内容是什么；数据在什么情况下会更新，更新的逻辑是什么。

###### 选择业务过程及确定事实表类型

明确了业务需求以后，接下来需要进行详细的需求分析，对业务的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关的业务过程。

![](../picture/2/312.png)

业务过程通常使用行为动词表示业务执行的活动。上图的淘宝订单流转的业务过程有四个：创建订单、买家付款、卖家发货、 买家确认收货

在明确了流程所包含的业务过程后，需要根据具体的业务需求来选择与维度建模有关的业务过程。比如是选择买家付款这个业务过程，还是选择创建订单和买家付款这两个业务过程，具体根据业务情况来确定。

 在选择了业务过程以后，相应的事实表类型也随之确定了。比如选择买家付款这个业务过程，那么事实表应为只包含买家付款这个业务过程的单事务事实表；如果选择的是所有四个业务过程，并且需要分析各个业务过程之间的时间间隔，那么所建立的事实表应为包含了所有四个业务过程的累积快照事实表。

###### 声明粒度

粒度的声明意味着精确定义事实表的每一行所表示的业务含义，粒度传递的是与事实表度量有关的细节层次。明确的粒度能确保对事实表中行的意思的理解不会产生混淆，保证所有的事实按照同样的细节层次记录。 

对于订单过程而言，粒度可以被定义为最细的订单级别。 比如在淘宝订单中有父子订单的概念，即一个子订单对应一种商品，如果拍下了多种商品，则每种商品对应一个子订单：这些子订单一同结算的话，则会生成一个父订单。那么在这个例子中，事实表的粒度应该选 择为子订单级别。 

###### 确定维度 

完成粒度声明以后，也就意味着确定了主键，对应的维度组合以及相关的维度字段就可以确定了，应该选择能够描述清楚业务过程所处的环境的维度信息。比如在淘宝订单付款事务事实表中，粒度为子订单， 相关的维度有买家、卖家、商品、收货人信息、业务类型、订单时间等维度。 

###### 确定事实

事实可以通过回答“过程的度量是什么”来确定。应该选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致。 事实有可加性、半可加性、非可加性三种类型 需要将不可加性事实分解为可加的组件。 比如在淘宝订单付款事务事实表中，同粒度的事实有子订单分摊的 支付金额、邮费、优惠金额等。 

###### 冗余维度 

在大数据的事实表模型设计中，通常事实表中会冗余方便下游用户使用的常用维度，以实现对事实表的过滤查询、控制聚合层次、排序数据以及定义主从关系等操作。

#### 事务事实表

订单作为交易行为的核心载体，直观反映了交易的状况。订单的 转会产生很多业务过程，而下单、支付和成功完结三个业务过程是整个 订单的关键节点。获取这三个业务过程的笔数、金额以及转化率是日常数据统计分析的重点，事务事实表设计可以很好地满足这个需求。

##### 设计过程

任何类型的事件都可以被理解为一种事务。比如交易过程中的创建订单、买家付款，物流过程中的揽货、发货、签收。事务事实表， 即针对这些过程构建的一类事实表，用以跟踪定义业务过程的个体行为，提供丰富的分析能力，作为数据仓库原子的明细数据。下面以淘宝交易事务事实表为例，阐述事务事实表的一般设计过程。

######  选择业务过程 

淘宝交易订单的流转过程中有四个重要过程：创建订单、买家付款、 卖家发货、买家确认收货，即下单、支付 发货和成功完结四个业务过程。这四个业务过程不仅是交易过程中的重要时间节点 ，而且也是下游统计分析的重点，因此淘宝交易事务事实表设计着重从这四个业务过程，为了便于进行独立的分析研究，为每个业务过程建立一个事实表。 

######  确定粒度 

业务过程选定以后，就要针对每个业务过程确定一个粒度，即确定事务事实表每一行所表达的细节层次。

###### 确定维度 

选定好业务过程并且确定粒度后，就可以确定维度信息了。在淘宝交易事务事实表设计过程中，按照经常用于统计分析的场景，确定维度包含： 买家、卖家、商品、商品类目、发货地区、收货地区、父订单维度以及杂项维度。

###### 确定事实 

作为过程度量的核心，事实表应该包含与其描述过程有关的所有事 实。以淘宝交易事务事实表为例，选定 个业务过程一一下单、支付和 成功完结，不同的业务过程拥有不同的事实。

经过以上四步，淘宝交易事务事实表已成型，可以满足下游分析统计的需要

![](../picture/2/313.png)

###### 冗余维度

在确定维度时，包含了买卖家维度、商品维度、类目维度 、收发货 维度等，  而淘宝交易事务事实表在维度建模基础之上做了进一步的优化，将买卖家星级、标签、店铺名称、商品类型、商品特征、商品属性、 目层级等维度属性都冗余到事实表中，提高对事实表进行过滤查询

![](../picture/2/314.png)

##### 单事务事实表

单事务事实表，顾名思义，即针对每个业务过程设计一个事实表。 这样设计的优点不言而喻，可以方便地对每个业务过程进行独立的分析研究

1688 交易主要流程有下单、支付、发货和完结，而在这四个关键流程中 1688 交易选择下单和支付两个业务过程设计事务事实表，分别是 1688 交易订单下单事务事实表 1688 交易订单支付事务事实表。 

选定业务过程后，将对每个业务过程确定粒度、维度和事实。对于 1688 交易订单下单事务事实表，确定子订单粒度，选择买家、卖家、 商品、父订单、收货地区维度，事实包含下单分摊金额和折扣金额，如图所示：而对于 1688 交易订单支付事务事实表 ，粒度和维度与交易订单下单事务事实表相同，所表达的事实则不一样 ，包含支付金额、 支付调整金额和支付优惠等。

![](../picture/2/315.png)

1688 交易针对下单和支付分别建立单事务事实表后，每天的下单 记录则进入当天的下单事务事实表 中，每天的支付记录进入当天的支付事务事实表中，由于事实表具有稀疏性质 ，因此只有当天数据才会进入 当天的事实表中。

![](../picture/2/329.png)

##### 多事务事实表

多事务事实表将不同的事实放到同一个事实表中，即同一个事实表包含不同的业务过程。多事务事实表在设计时有两种方法进行事实的处理 ①不同务过程的事实使用不同的事实字段进行存放：②不同业务过程的事实使用同一个事实字段进行存放，但增加一个业务过程标签

淘宝交易事务事实表采取将不同业务过程的事实使用不同事实字段进行存放的设计模式。淘宝交易事务事实表 中同时包含了下单、支付和成功完结三个业务过程，这三个业务过程拥有相同的粒度，都是子订单粒度，也比较适合放到同一个事实表中。选择业务过程时没有把发货也加到此事务事实表中，原因是发货的粒度比子订单更细，属于不同粒度上的业务过程，因此没有放到同一个事实表中。 

在确定好业务过程和粒度后，下一步就是确定维度和事实。对于不同的业务过程和粒度，一般而言，维度也不完全一致。但是在设计淘宝交易事务事实表时，根据分析统计，常用维度比较一致 。这里的维度也是在交易过程中比较常见的，如包括买家、卖家、商品、类目、店铺、收发货地区。

将多个业务过程放到同一个事实表中，将要面对的是如何处理多个事实。淘宝交易事务事实表中包含了下单 、支付和成功完结三个业务过程，则需要包含下单度量、支付度量和成功完结度量信息 ，这里的解决方案是针对每个度量都使用一个字段进行保存 ，即不同的事实使用不同的字段进行存放；如果不是当前业务过程的度量，则采取零值处理方式。 比如在下单业务过程中，对于支付度量和成功完结度量全部置为0，其他业务过程类似处理。

![](../picture/2/316.png)

![](../picture/2/317.png)

用户可以直接收藏一个商品，也可以删除所收藏的商品，所以在这个过程中包含了两个业务过程：收藏商品和删除商品。

因此收藏商品事务事实表的第一步就是选择收藏商品和删除商品两个业务过程。 业务过程确定后，接下来就是确定粒度。无论是收藏商品还是删除所收藏的商品，都是用户对商品的一个操作，因此这里确定为用户加上商品的粒度。 

确定好业务过程和粒度后，接下来是确定维度和事实。由于粒度是用户加上商品，所以维度主要是用户维度和商品维度。 收藏商品和删除商品是两个不同的业务过程，但是确定了相同的粒度和维度 ，所以考虑设计多事务事实表 ，将这两个业务过程放到同一事实表中 ，只是在不同业务过程的事实上进行区分。

![](../picture/2/318.png)

##### 父子事实的处理方式

在同一个店铺同时下单多种商品，不仅每种商品有一个子订单，而且这几个子订单会再单独产生一个父订单。下单和支付都是在父订单粒度上完成的，比如拍下时的订单总额、支付总额、支付邮费，淘宝交易事务事实表在粒度选择上，按照粒度最细原则，确定为子订单，因此需要将下单总额或者支付总额分摊到每个子订单上，当然只有一个子订单时是不需要进行 分摊的。

通过分摊父订单的金额将所有业务过程的度量全部带进淘宝交易事务事实表中 ，包括下单数量、商品价格、子订单折扣、下单分摊比例、 父订单支付金额、父订单支付邮费、父订单折扣、子订单下单金额、子订单下单有效金额、支付分摊比例、子订单支付金额等，将父子事实同时冗余到事务表中。

##### 事实的设计准则

事实完整性。事实表包含与其描述的过程有关的所有事实，即尽可能多地获取所有的度量。

事实一致性。在确定事务事实表的事实时，明确存储每一个事实以确保度量一致性。

事实可加性。事实表确定事实时，往往会遇到非可加性度量 ，比如分摊比例、利润率等，但事务事实表中关注更多的是可加性事实。在淘宝交易务事实表中，存储了分摊比例这样的度量，但更多的是存储各类金额的 度量。

#### 周期快照事实表

快照事实表在确定的间隔内对实体的度量进行抽样，这样可以很容易地研究实体的度量值，而不需要聚集长期事务历史。接下来将以淘宝交易结束后的评价数据、 卖家的累积支 金额、买卖家星级等事实表的设计为例，介绍快照事实表在阿里巴巴数据仓库中的设计与应用。

##### 特性

事务事实表的粒度能以多种方式表达，但快照事实表的粒度通常以维度形式声明；事务事实表是稀疏的，但快照事实表是稠密的；事务事实表中的事实是完全可加的，但快照模型将至少包含一个用来展示半可加性质的事实。

快照事实表以预定的间隔采样状态度量。这种间隔联合一个或多个维度，将被用来定义快照事实表的粒度，每行都将包含记录所涉及状态 的事实。如下图所示的快照事实表记录了每个卖家的下单和支付情况。

![](../picture/2/319.png)

事务事实表的粒度可以通过业务过程中所涉及的细节程度来描述， 但快照事实表的粒度通常总是被多维声明，可以简单地理解为快照需要采样的周期以及什么将被采样。在淘宝交易卖家快照事实表中，粒度可以被理解为每天针对卖家的历史截至当日的下单支付金额进行快照。当然，快照周期不一定都按天来进行，也可以按照月或者季度来统计。

快照事实表和事务事实表的一个关键区别在密度上。事务事实表是稀疏的，只有当天发生的业务过程，事实表才会记录该业务过程的事实， 如下单、支付等；而快照事实表是稠密的，无论当天是否有业务过程发生，都会记录一行，比如针对卖家的历史至今的下单和支付金额，无论当天卖家是否有下单支付事实，都会给该卖家记录一行。稠密性是快照事实表的重要特征，如果在每个快照周期内不记录行，比如和事务事实 表一样，那么确定状态将变得非常困难。

在快照事实表中收集到的状态度量都是半可加的。与事务事实表的 可加性事实不同，半可加性事实不能根据时间维度获得有意义的汇总结 果。比如对于淘宝交易事务事实表，可以对个周期内的下单金额或者 支付金额进行汇总，得到下单支付总额，但快照事实表在每个采样周期 内是不能对状态度量进行汇总的。

##### 实例

对于快照事实表的设计步骤可以归纳为：确定快照事实表的快照粒度；确定快照事实表采样的状态度量

##### 单维度的每天快照事实表

确定粒度：采样周期为每天，针对卖家、卖家、商品、类目、地区等维度的快照事实表，如淘宝卖家历史至今汇总事实表，不同的采样粒度确定了不同的快照事实表。

确定状态度量：确定粒度后，就要针对这个粒度确定需要采样的状态度量。如淘宝卖家历史至今汇总事实表，包含了历史截至当日的下单金额、历史截止当日的支付金额等度量

![](../picture/2/320.png)

淘宝商品历史至今快照事实表，确定了商品维度和商品状态度量。

![](../picture/2/330.png)

###### 混合维度的每天快照事实表

混合维度相对于单维度，只是在每天的采样周期上针对多个维度进行采样。比如淘宝买卖家历史至今快照事实表，采样周期依然是每天，维度是卖家加买家，反映的是不同买家对于不同卖家的下单支付金额。

![](../picture/2/331.png)

以上两类快照事实表都有一个特点一一都可以从事务事实表进行 汇总产 出，这是周期快照事实表常见的 种产出模式。除此之外，还有 种产出模式，即直接使用操作型系统的数据作为周期快照事实表的数据源进行加工。

阿里数据仓库关于淘宝卖家信用分快照事实表是直接采用操作型系统数据进行设计加工，采样周期是每天，针对卖家维度的统计，状态度量就是卖家信用分。

![](../picture/2/332.png)

##### 全量快照事实表

确定粒度，淘宝好重差评每天都在变化，下游统计分析也是每天都在进行，因此确定采样周期是每天。这里的采样维度比较特殊，是针对评价本身，即每天按照评价进行采样的，每一条好中差评评价就是快照事实表的最细粒度。

确定状态度量，对于好中差评的度量关注更多的是评价本身，因此设计为无事实的事实表，更多关注评价的状态。

![](../picture/2/333.png)

#### 累计快照事实表

对于类似于研究事件之间时间间隔的需求，采用累积快照事实表可以很好地解决。对于累积快照事实表，其建模过程和事务事实表相同，适用于维度 建模的步骤。下面详述淘宝交易累积快照事实表的设计过程

第一步 选择业务过程。在统计事件时间间隔的需求中， 卖家发货也是关键环节。所以针对淘宝交易累积快照事实表，我们选择这四个业务过程

第二步:确定粒度。对于累积快照事实表，用于考察实体的唯一实例，所以子订单在此表中只有一行记录,事件发生时，对此实例进行更新。

第三步:确定维度。与事务事实表相同，维度主要有买家、卖家、店铺、商品、类目、发货地区、收货地区等。四个业务过程对应的时间字段,格式为日期+时间，分别为下单时间、支付时间、发货时间、确认收货时间。

第四步:确定事实。对于累积快照事实表，需要将各业务过程对应的事实均放入事实表中。比如淘宝交易累积快照事实表，包含了各业务过程对应的事实，如下单对应的下单金额，支付对应的折扣、邮费和支付金额，确认收货对应的金额等。累积快照事实表解决的最重要的问题是统计不同业务过程之间的时间间隔，建议将每个过程的时间间隔作为事实放在事实表中。

![](../picture/2/336.png)

第五步:退化维度。在大数据的事实表模型设计中，更多的是考虑提高下游用户的使用效率,降低数据获取的复杂性,减少关联的表数量。

事务事实表记录事务发生时的状态，对于实体的某一实例不再更新﹔而累积快照事实表则对实体的某一实例定期更新。

![](../picture/2/337.png)

对于累积快照事实表，则只有一条记录，针对此记录不断更新，

![](../picture/2/338.png)

累积快照事实表适用于具有较明确起止时间的短生命周期的实体， 比如交易订单、物流订单等，对于实体的每 个实例，都会经历从诞生到消亡等一系列步骤。对于商品、 用户等具有长生命周期的实体， 采用周期快照事实表更合适。

##### 物理实现

第一种方式是全量表的形式。此全量表一般为日期分区表，每天的分区存储昨天的全量数据和当天的增量数据合并的结果,保证每条记录的状态最新。此种方式适用于全量数据较少的情况。如果数据量很大，此全量表数据量不断膨胀,存储了大量永远不再更新的历史数据,对ETL和分析统计性能影响较大。

第二种方式是全量表的变化形式。此种方式主要针对事实表数据量很大的情况。较短生命周期的业务实体一般从产生到消亡都有一定的时间间隔，可以测算此时间间隔，或者根据商业用户的需求确定一个相对较大的时间间隔。比如针对交易订单，我们以200天作为订单从产生到消亡的最大间隔。设计最近200天的交易订单累积快照事实表，每天的分区存储最近200天的交易订单

第三种方式是以业务实体的结束时间分区。每天的分区存放当天结束的数据，设计一个时间非常大的分区,比如3000-12-31，存放截至当前未结束的数据。由于每天将当天结束的数据归档至当天分区中,时间非常大的分区数据量不会很大，ETL性能较好；且无存储的浪费，对于业务实体的某具体实例，在该表的全量数据中唯一。

##### 事实表的比较

|            | 事务事实表             | 周期快照事实表                   | 累积快照事实表                       |
| ---------- | ---------------------- | -------------------------------- | ------------------------------------ |
| 时间/日期  | 离散事务时间点         | 以有规律的、可预测的间隔产生快照 | 用于时间跨度不确定的不断变化的工作流 |
| 日期维度   | 事务日期               | 快照日期                         | 相关业务过程的多个日期               |
| 粒度       | 每行代表实体的一个事务 | 每行代表某时间周期的一个实体     | 每行代表一 实体的生命周期            |
| 事实       | 事务事实               | 累积事实                         | 相关业务过程事实和时间间隔事实       |
| 事实表加载 | 插入                   | 插入                             | 插入与更新                           |
| 事实表更新 | 不更新                 | 不更新                           | 业务过程变更时更新                   |

事务事实表记录的事务层面的事实，用于跟踪业务过程的行为，并 支持几种描述行为的事实，保存的是最原子的数据，也称为“原子事实 表”。事务事实表 中的数据在事务事件发生后产生，数据的粒度通常是 每个事务一条记录。 一旦事务被提交，事实表数据被插人，数据就不能 更改，其更新方式为增量更新。

周期快照事实表以具有规律性的、可预见的时间间隔来记录事实， 如余额、库存、层级、温度等，时间间隔为每天、每月、每年等，典型 的例子如库存日快照表等。周期快照事实表的日期维度通常记录时间段 的终止日，记录的事实是这个时间段内一些聚集事实值或状态度量。事 实表的数据一旦插人就不能更改，其更新方式为增量更新。 累积快照事实表被用来跟踪实体的一系列业务过程的进展情况 ，它 通常具有多 个日期字段，用于研究业务过程中的里程碑过程的时间间 隔。



#### 无事实的事实表

常见的无事实的事实表主要有如下两种： 第一种是事件类的，记录事件的发生。在阿里巴巴数据仓库中，最常见的是日志类事实表。比如用户的浏览日志，某会员某时间点浏览了淘宝首页、某会员某时间点浏览了某卖家的店铺中的某商品详情页等。对于每次点击，其事实为1，但一般不会保存此事实。 第二种是条件、范围或资格类的，记录维度与维度多对多之间的关系。比如客户和销售人员的分配情况、产品的促销范围等。

#### 聚集型事实表

聚集主要是通过汇总明细粒度数据来获得改进查询性能的效果。通过访问聚集数据，可以减少数据库在响应查询时必须执行的工作量，能够快速响应 用户的查询，同时有利于减少不同用户访问明细数据带来的结果不一致 问题。

聚集粒度可不同。聚集并不需要保持与原始明细粒度数据 样的 粒度，聚集只关心所需要查询的维度。

避免单 表设计。不要在同 个表中存储不同层次的聚集数据 否则将会导致双重计算或出现更糟糕的事情。

一致性。聚集表必须提供与查询明细粒度数据 致的查询结果。 从设计角度来看，确保 致性，最简单的方法是确保聚集星形模 型中的维度和度量与原始模型中的维度和度量保持一致。

第一步：确定聚集维度。 在原始明细模型中会存在多个描述事实的维度 ，如 日期、商品类 卖家等，这时候需要确定根据什么维度聚集 ，如果只关 商品的交易额 情况，那么就可以根据商品维度聚集数据。

第二步：确定一致性上钻。 这时候要关心是按月汇总还是按天汇总，是按照商品汇总还是按照 类目汇总，如果按照类目汇总，还需要关心是按照大类汇总还是小类汇 总。当然，我们要做的只是了解用户需要什么，然后按照他们想要的进 行聚集。 

第三步：确定聚集事实。 在原始明细模型中可能会有多个事实的度量，比如在交易中有交易 额、交易数量等，这时候要明确是按照交易额汇总还是按照成交数量汇总。

聚集是指针对原始明细粒度的数据进行汇总。假定已有的交易订单明细模型，可以看出事实和商品、卖家、买家等维度关联

![](../picture/2/334.png)

按商品粒度汇总 确定聚集维度一一商品；确定一致性上钻一一按商品（商品 ID ）最近 天汇总。 确定聚集事实一一下单量、交易额。

![](../picture/2/335.png)

可以看出聚集的事实都是原始模型中的事实，聚集的维度也是原始 模型维度中的商品维度，去掉了其他不关心的维度。

聚集是针对原始星形模型进行的汇总，为了获取和查询与原始模型 一致的结果，聚集的维度和度量必须与原始模型保持一致，因 此聚集 不跨越事实的