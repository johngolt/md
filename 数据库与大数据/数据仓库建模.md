数据仓库描述为一个面向主题的、集成的、 随时间变化的、非易失的数据集合，用于支持管理者的决策过程。

| 名称       | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| 面向主题   | 主题简单地说就是与业务相关的数据的类别，每一个主题基本对应一个宏观的分析领域。例如，一个公司要分析销售数据，可以建立一个销售的数据仓库。主题域是对某个主题进行分析后确定的主题的边界。 |
| 集成       | 将分散在不同产品线的数据库进行汇总集成到数据仓库中。         |
| 随时间变化 | 数据仓库关注的是数据随时间变化的情况，并且能反映在过去某个时间点的数据是怎样的。数据仓库中的数据是反映了某一历史时间点的数据快照 |
| 非易失     | 一旦进入到数据仓库中，数据就不应该再有改变。当改变的操 作型数据进入数据仓库时会产生新的记录，这样就保留了数据变化的历史轨迹。也就是说，数据仓库中的数据基本是静态的。 |

### 数据整合及管理体系

##### 体系架构

业务板块是根据业务的属性划分出几个相对独立的业务板块，业务板块之间的指标或业务重叠性较小 

![体系架构](../picture/2/306.png)

#### 规范定义

结合行业的数据仓库建设经验设计出的一套数据规范命名体系，规范定义将会被用在模型设计中。

规范定义指以维度建模作为理论基础，构建总线矩阵，划分和定义数据域、业务过程、维度、度量/原子指标、修饰类型、修饰词、时间周期、派生指标。

![](../picture/2/173.png)

![](../picture/2/174.png)

##### 名词术语

| 名称     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 业务过程 | 指企业的业务活动事件，如下单、支付、退款都是业务过程，业务过程是一个不可拆分的行为事件 |
| 维度     | 维度是度量的环境，用来反映业务的一类属性 这类属性的集合构成一个维度，维度也可以称为实体对象 |
| 维度属性 | 维度属性隶属于一个维度，如地理维度里面的国家名称、国家ID 、省份名称等都属于维度属性 |
| 业务限定 | 统计的业务范围，筛选出符合业务规则的记录。                   |
| 统计周期 | 用来明确数据统计的时间范用或者时间点，如最近 30 天、自然周、截至当日等 |
| 修饰类型 | 是对修饰词的一种抽象划分。修饰类型从属于某个业务域，如日志域的访问终端类型涵盖无线端、PC端等修饰词。 |
| 派生指标 | 时间周期+修饰词+原子指标，派生指标可以理解为对原子指标业务统计范围的圈定。 |

| 名称     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 原子指标 | 基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名词，通常是业务过程+度量组合而成，如支付金额。 |
| 修饰词   | 指出了统计维度以外指标的业务场景限定抽象，修饰词隶属于一种修饰类型，如日志域的访问终端类型有修饰词PC端、无线端等。 |
| 派生指标 | 时间周期+修饰词+原子指标，派生指标可以理解为对原子指标业务统计范围的圈定。如原子指标：支付金额，最近一天海外买家支付金额则为派生指标（最近1天为时间周期 海外为修饰词，买家作为维度，而不作为修饰词） |

##### 指标体系

###### 基本原则

原子指标、修饰类型及修饰词，直接归属在业务过程下，其中修饰词继承修饰类型的数据域；

派生指标可以选择多个修饰词，派生指标唯一归属一个原子指标 ，继承原子指标的数据域， 与修饰词的数据域无关。

一般事务型指标和存量型指标只会唯一定位到一个业务过程，如果遇到同时有两个行为发生、需要多个修饰词、生成一个派生指标的情况，则选择时间靠后的行为创建原子指标，选择时间靠前的行为创建修饰词。 

原子指标有确定的英文字段名、数据类型和算法说明：派生指标要继承原子指标的英文名、数据类型和算法要求。

- 命名所用术语。指标命名，尽量使用英文简写，其次是英文， 指标英文名太长时，可考虑用汉语拼音首字母命名。
- 业务过程。英文名：用英文或英文的缩写或者中文拼音简写；中文名：具体的业务过程中文即可

关于存量型指标对应的业务过程的约定：实体对象英文名+stock 。如在线会员数对应的业务过程为`mbr_stock`

- 原子指标。英文名 ：动作＋度量：中文名：动作＋度量。原子指标必须挂靠在某个业务过程下
- 修饰词。只有时间周期才会有英文名，且长度为2位，加上`_` ，为3位，例`_1d` 。其他修饰词无英文名。
- 派生指标。英文名：原子指标英文名＋时间周期修饰词＋序号（4 位，如\_001 ）；中文名：时间周期修饰词 ＋［其他修饰词］＋原子指标。

###### 操作细则

| 派生指标类型 | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 事务型指标   | 是指对业务活动进行衡量的指标。例如新发商品数、 重发商品数、新增注册会员数、订单支付金额，这类指标需维护原子指标及修饰词，在此基础上创建派生指标。 |
| 存量型指标   | 是指对实体对象（如商品、会员）某些状态的统计。 例如商品总数、注册会员总数，这类指标需维护原子指标及修饰词，在此基础上创建派生指标，对应的时间周期一般为“历史截至当前某个时间”。 |
| 复合型指标   | 是在事务型指标和存量型指标的基础上复合而成 的。例如浏览UV-下单买家数转化率，有些需要创建新原子指标， 有些则可以在事务型或存量型原子指标的基础上增加修饰词得到派生指标。 |

按照其特性不同，有些必须新建原子指标，有些可以在其他类型原子指标的基础上增加修饰词形成派生指标。 

| 复合型指标 | 规则                                                         |
| ---------- | ------------------------------------------------------------ |
| 比率型     | 创建原子指标，如 CTR，如最近1天店铺首页CTR，原子指标为`CTR`，时间周期为“最近 天”，修饰类型为“页面类型”，修饰词为“店铺首页”。 |
| 比例型     | 创建原子指标，如百分比，如“最近1天无线支付金额占比”，原子指标为“支付金额占比”，修饰类型为“终端类型”，修饰词为“无线”。 |
| 变化量型   | 不创建原子指标，增加修饰词，在此基础上创建派生指标。例如，“最近1天订单支付金额上1天变化量”，原子指标 为“订单支付金额”，时间周期为“最近1天”，修饰类型为“统计方法”，修饰词为“上1天变化量”。 |
| 变化率型   | 创建原子指标。如“最近7天海外买家支付金额上7天变化率”，原子指标为“支付金额变化率”，修饰类型为“ 买家地域”，修饰词为“海外买家”。 |
| 统计型     | 不创建原子指标，增加修饰词；在修饰类型 “统计方法”下增加修饰词， 如人均、日均、行业平均等。 如“自然月日均 UV”，原子指标为“UV”，修饰类型为“统计方法”，修饰词为“日均”。 |
| 排名型     | 创建原子指标， 一般为 `top_xxx_xxx`。创建派生指标时选择对应的修饰词如下： 统计方法，如降序、升序；排名名次；排名范围，行业、省份、一级来源等；根据什么排序，如搜索次数。 |

上下层级派生指标同时存在时：如最近1天支付金额和最近一天PC 端支付金额，建议使用前者， PC 端作为维度属性存放在物理表中体现。

父子关系原子指标存在时：派生指标使用子原子指标创建派生指标。如`PV`，`IPV `商品详情页 `PV `，当统计商品详情页`PV`时，优先选择子原子指标。

#### 模型设计

以维度建模理论为基础，基于维度建模总线架构，构建一致性的维度和事实（进行规范定义）。同时，在落地表模型时，设计出一套表规范命名体系

模型设计基本原则：高内聚和低耦合、核心模型与扩展模型分析、公共处理逻辑下沉及单一、成本与性能平和、数据可回滚、一致性、命名清晰可理解

##### 模型层次

![](../picture/2/238.png)

数据仓库一般要进行分层的设计，其能带来五大好处：

- 清晰数据结构，每一个数据分层都有它的作用域，方便数据表定位和理解。

- 数据血缘追踪，能够快速准确地定位到问题，并清楚它的危害范围。

- 减少重复开发，规范数据分层，开发通用的中间层数据，减少重复计算。

- 复杂问题简单化，将复杂的任务分解成多个步骤完成，每层只处理单一的步骤。

- 屏蔽原始数据的异常，不必改一次业务就需要重新接入数据。

数据分层理论在实际应用中的技术挑战是非常大的：

1. 关联范围广，有些数据是需要跨多个业务线的，每个业务线的数据都很大，这时候不仅是计算逻辑复杂无比，而且对于数据倾斜的问题挑战更大。
2. 血缘关系乱，`ADS`的某些表可能需要中间层的表关联几张甚至十几张表，被关联的表可能也要关联很多表，导致中间表上游特别多，出现数据异常时难以追溯问题。
3. 产出时间长，某些`DWS`表需要几个小时的计算时间，影响数据的准时产出。对于小时级的报表统计，太过于复杂的中间层设计就显得累赘。
4. 重构难度大，适应分层理论会导致大多数原有的统计逻辑重写，并且很可能需要双平台同时进行数据计算，以渡过重构的不稳定期。

###### 操作数据层`ODS`

把操作系统数据几乎无处理地存放在数据仓库系统中。 同步：结构化数据增量或全量同步；结构化：非结构化结构化处理并存储。 累积历史、清洗：根据数据业务需求及稽核和审计要求保存历史数据、清洗数据。

数据引入层存储：为了满足历史数据分析需求，您可以在ODS层表中添加时间维度作为分区字段。实际应用中，您可以选择采用增量、全量存储或拉链存储的方式。 

- 增量存储：以天为单位的增量存储，以业务日期作为分区，每个分区存放日增量的业务数据。 
- 全量存储：以天为单位的全量存储，以业务日期作为分区，每个分区存放截止到业务日期为止的全量业务数据。
- 拉链存储：拉链存储通过新增两个时间戳字段（`start_dt`和`end_dt`），将所有以天为粒度的变更数据都记录下来，通常分区字段也是这两个时间戳字段。

| 名称   | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| 全量表 | 全量表没有分区，表中的数据是前一天的所有数据，每次往全量表里面写数据都会覆盖之前的数据，全量表不能记录历史的数据情况，只有截止到当前最新的、全量的数据。 |
| 快照表 | 快照表是有时间分区的，每个分区里面的数据都是分区时间对应的前一天的所有全量数据。比如当前数据表有2个分区，24号、25号，其中，24号分区里面的数据就是从历史到23号的所有数据 |
| 增量表 | 记录每天新增数据的表，比如，从24号到25号新增了哪些数据，改变了哪些数据，这些都会存储在增量表的25号分区里面，只报变化量，没有变化不用报 |
| 链表   | 它是一种维护历史状态，以及最新状态数据的一种表。 是分区表，有些不变的数据或者是已经达到状态终点的数据就把它放在分区里面，分区字段一般为开始时间：start_date和结束时间:end_date。 |
| 维度表 | 维度表可以看成是用户用来分析一个事实的窗口，它里面的数据应该是对事实的各个方面描述，比如时间维度表，它里面的数据就是一些日，周，月，季，年，日期等数据，维度表只能是事实表的一个分析角度。 |
| 实体表 | 实体表就是一个实际对象的表，实体表它放的数据一定是一条条客观存在的事物数据，比如说设备 ，它就是客观存在的，所以可以将其设计一个实体表。 |
| 事实表 | 实质就是通过各种维度和一些指标值得组合来确定一个事实的，比如通过时间维度，地域组织维度，指标值可以去确定在某时某地的一些指标值怎么样的事实。事实表的每一条数据都是几条维度表的数据和指标值交汇而得到的。 |

拉链表使用情况：数据量有点大，表中某些字段有变化，但是呢变化的频率也不是很高，业务需求呢又需要统计这种变化状态

###### 数据明细层`DWD`

该层一般保持和ODS层一样的数据粒度，并且提供一定的数据质量保证。同时，为了提高数据明细层的易用性，该层会采用一些维度退化手法，将维度退化至事实表中，减少事实表和维表的关联。另外，在该层也会做一部分的数据聚合，将相同主题的数据汇集到一张表中，提高数据的可用性

###### 数据中间层`DWM`

该层会在DWD层的数据基础上，对数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。直观来讲，就是对通用的核心维度进行聚合操作，算出相应的统计指标。

###### 数据服务层`DWS`

数据集市或宽表。按照业务划分，如流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等。

一般来讲，该层的数据表会相对比较少，一张表会涵盖比较多的业务内容，由于其字段较多，因此一般也会称该层的表为宽表。

存放明细事实数据、维表数据及公共指标汇总数据，其中明细事实数据、维表数 一般根据 ODS 层数据加工生成；公共指标汇总数据一般根据维表数据和明细事实数据加工生成。 

###### 应用数据层`APP`

存放数据产品个性化的统计指标数据，根据 CD 层与 ODS 层加工生成个性化指标加工：不公用性、复杂性（指数型、比值型、排名型 指标）。

###### 维度层`DIM`

维表层主要包含两部分数据：

高基数维度数据：一般是用户资料表、商品资料表类似的资料表。数据量可能是千万级或者上亿级别。

低基数维度数据：一般是配置表，比如枚举值对应的中文含义，或者日期维表。数据量可能是个位数或者几千几万。

###### 数仓分层案例

如下图认为是一个电商网站的数据体系设计。我们只关注用户访问日志这一部分数据。

在ODS层中，开发团队不同或者各种其它问题，用户的访问日志被分成了好几张表上报到了我们的ODS层。为了方便大家的使用，我们在`DWD`层做了一张用户访问行为天表，在这里，我们将PC网页、`H5`、小程序和原生`APP`访问日志汇聚到一张表里面，统一字段名，提升数据质量，这样就有了一张方便使用的明细表了。

在`DWM`层，我们会从`DWD`层中选取业务关注的核心维度来做聚合操作，比如只保留人、商品、设备和页面区域维度。类似的，我们这样做了很多个`DWM`的中间表

然后在`DWS`层，我们将一个人在整个网站中的行为数据放到一张表中，这就是我们的宽表了，有了这张表，就可以快速满足大部分的通用型业务需求了。

最后，在`APP`应用层，根据需求从`DWS`层的一张或者多张表取出数据拼接成一张应用表即可。

![](../picture/2/345.png)

#### 模型实施

如何从具体的需求或项目转换为可实施的解决方案，如何进行需求分析、架构设计、详细模型设计。

##### 数据调研

###### 业务调研 

一个大的公司集团涉及的业务涵盖多个不同的领域，如阿里涉及电商、数字娱乐、导航、移动互联网服务等。每一个领域又涵盖多个业务线，如阿里电商就涵盖`C`类：淘宝、天猫；`B`类：国际站等业务。

构建数据仓库前需要明确是涵盖所有业务领域，还是各个业务领域独自建设；在业务领域内，是涵盖所有业务线，还是各个业务线独自建设。

构建大数据数据仓库前需要了解各个业务领域、业务线的业务有什么共同不同点 ，以及各个业务线可以细分为哪几个业务模块，每个业务模块具体的业务流程又是怎样的。

了解业务线部门的组织结构和分工界面，针对不同部门分别进行调研需求和数据应用；各个业务模块之间的联系与信息流动的流程，梳理出整体的业务数据框架；各个已有的业务系统的主要功能及获取的数据。

![](../picture/2/321.png)

###### 需求调研

了解了业务系统的业务后要做的就是收集数据使用者的需求。 需求调研的途径有两种： 是根据与分析师、业务运营人员的沟通获知需求；二是对报表系统中现有的报表进行研究分析。在需求分析阶段，需要沉淀出业务分析或报表中的指标，以及指标的定义和粒度。   				                     

- 业务数据是根据什么汇总，汇总的范围是多大，衡量标准是什么？
- 明细数据层和汇总数据层如何设计？公共维度层如何设计？是否有公共的指标？
- 数据是否需要冗余、沉淀到汇总数据层中？

##### 技术调研

##### 架构设计

###### 数据域划分

数据域是指面向业务分析，将业务过程或者维度进行抽象的集合。 业务过程可以概括为 一个个不可拆分的行为事件，如下单、支付、退款。 为保障整个体系的生命力，数据域需要抽象提炼，并且长期维护和更新， 但不轻易变动。在划分数据域时，既能涵盖当前所有的业务需求，又能在 新业务进入时无影响地被包含进已有的数据域中或者扩展新的数据域。

![](../picture/2/309.png)

根据上图的业务过程进行归纳，抽象出的数据域

![](../picture/2/310.png)

###### 构建总线矩阵

在进行充分的业务调研和需求调研后，就要构建总线矩阵了。需要做两件事情 ：明确每个数据域下有哪些业务过程；业务过程与哪些维度 相关，并定义每个数据域下的业务过程和维度。

![](../picture/2/311.png)

##### 规范定义

规范定义主要定义指标体系，包括原子指标、修饰词、时间周期和 派生指标。

##### 模型设计

模型设计主要包括维度及属性的规范定义，维表、明细事实表和汇总事实表的模型设计
