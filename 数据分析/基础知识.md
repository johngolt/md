##### 方差分析

方差分析是通过检验各个总体均值是否相等来判断分类型自变量对数值型自变量是否有显著影响。在方差分析中，所要检验的对象称为因素，因素的不同表现称为水平，因素的每一个水平都可以看作一个总体，每个因素水平下得到样本数据称为观测值。

###### 误差分解

来自于水平内部的数据误差称为组内误差，它是由抽样的随机性造成的随机误差。显然，组内误差只含有随机误差。来自不同水平之间的数据误差称为组间误差，它可能由抽样造成的随机误差，也可能是由因素的不同水平造成的系统误差。组间误差是随机误差和系统误差的总和。反映全部数据误差大小的平方和称为总平方和，反映组内误差大小的平方和称为组内平方和，反映组间误差大小的平方和称为组间平方和。如果因素的不同水平对每个水平下的均值没有影响，则组间误差只有随机误差而没有系统误差。组内误差和组间误差的均方之比应该接近1；否则它们的比值就会大于1，当大到某个程度时，就认为因素的不同水平之间存在着显著差异，也即自变量（示例中的行业因素）对因变量（示例中的不同行业的被投诉次数）有显著影响。

###### 基本假定

每个总体都应符合正态分布；各个总体的方差$\sigma^2$必须相同；观测是独立的。

If these assumptions are not true for a given set of data, it may still be possible to use the Kruskal-Wallis H-test

###### 单因素方差分析

设有$k$组样本，每组有$n_i$个独立样本，$N$为样本总数。定义零假设$H_0:\mu_1=\mu_2=\cdots=\mu_k$ 。对应的备择假设  ：$H_1:$样本均值不完全相等

| 名称       | 公式                                                         |
| ---------- | ------------------------------------------------------------ |
| 各组均值   | $\overline{x}_i=\frac{1}{n_i}\sum_{j=1}^{n_i}x_{ij}$         |
| 各组方差   | $S_i=\frac{1}{n_i-1}\sum_{j=1}^{n_i}(x_{ij}-\overline{x}_i)^2$ |
| 总体均值   | $\mu=\frac{1}{N}\sum_{i=1}^k\sum_{j=1}^{n_i}x_{ij}$          |
| 总平方和   | $SST=\sum_{i=1}^k\sum_{j=1}^{n_i}(x_{ij}-\mu)^2$             |
| 组间平方和 | $SSA=\sum_{i=1}^k(\overline{x}_i-\mu)^2*n_i$                 |
| 组内平方和 | $SSE=\sum_{i=1}^k\sum_{j=1}^{n_i}(x_{ij}-\overline{x}_i)^2$  |
| 组间方差   | $MSA=\frac{SSA}{k-1}$                                        |
| 组内方差   | $MSE=\frac{SSE}{n-k}$                                        |

将组间方差与组内方差进行对比，就得到了所需的检验统计量F，当$H_0$为真时，有
$$
F=\frac{MSA}{MSE}\sim F(k-1,n-k)
$$
若$F>F_\alpha$，则拒绝原假设，因素水平对观测值有显著影响；若$F<F_\alpha$，则接受原假设，不能认为因素水平对观测值有显著影响。

###### 双因素方差分析（五交互作用）

将一个因素放在行的位置，称为行因素，设有$k$个水平；另一个因素放在列的位置，称为列因素，设有$r$个水平。

对行因素提出的假设为：$H_0:\mu_1=\mu_2=\cdots=\mu_k$ 。对应的备择假设  ：$H_1:$样本均值不完全相等对列因素提出的假设为：$H_0:\mu_1=\mu_2=\cdots=\mu_r$ 。对应的备择假设  ：$H_1:$样本均值不完全相等

$\overline{x}_{i\cdot}$是行因素的第i个水平下的观测值的平均值：$\overline{x}_{i\cdot}=\frac{1}{r}\sum_{j=1}^{r}x_{ij}$；列因素的第j个水平下的观测值的平均值:$\overline{x}_{\cdot j}=\frac{1}{k}\sum_{j=1}^{k}x_{ij}$；所有观测值的总平均值：$\mu=\frac{1}{kr}\sum_{i=1}^k\sum_{j=1}^rx_{ij}$

| 名称                 | 公式                                                         |
| -------------------- | ------------------------------------------------------------ |
| 总平方和             | $SST=\sum_{i=1}^k\sum_{j=1}^r(x_{ij}-\mu)^2$                 |
| 行因素的组间平方和   | $SSR=\sum_{i=1}^k\sum_{j=1}^r(\overline{x}_{i\cdot}-\mu)^2$  |
| 列因素的组间平方和   | $SSC=\sum_{i=1}^k\sum_{j=1}^r(\overline{x}_{\cdot j}-\mu)^2$ |
| 剩余因素产生的平方和 | $SSE=\sum_{i=1}^k\sum_{j=1}^r(x_{ij}-\overline{x}_{i\cdot}-\overline{x}_{\cdot j}+\mu)^2$ |
| 行因素均方           | $MSR=\frac{SSR}{k-1}$                                        |
| 列因素均方           | $MSC=\frac{SSC}{r-1}$                                        |
| 随机误差均方         | $MSE=\frac{SSE}{(k-1)(r-1)}$                                 |

检验行变量对因变量的影响，采用统计量$F_R$：$F=\frac{MSR}{MSE}\sim F(k-1,(k-1)(r-1))$

检验行变量对因变量的影响，采用统计量$F_C$：$F=\frac{MSC}{MSE}\sim F(r-1,(k-1)(r-1))$

将$F_R$和$F_C$与临界值$F_\alpha$进行比较：如果$F_R>F_\alpha$，则拒绝原假设$H_0$，行因素对观测值有显著影响；如果$F_C>F_\alpha$，则拒绝原假设$H_0$，列因素对观测值有显著影响。



对于变化量的归因，一般流程如下：

1. 判断波动的严重程度，需要设置对比的参照值和波动报警的阈值；
2. 排除数据问题，比如底层表是不是有改动或者有人修改了报表中的指标规则，一般来说新上线的业务比较容易出现数据问题；
3. 定位问题环节，将$\Delta Y$在更细的维度上拆解，时间维度上可以看是什么时候开始的以及持续了多久，空间维度上可以从“人货场”各维度拆分，看看是什么用户群、商品、业务场景问题最严重；
4. 是否历史有类似情况或者波动规律；
5. 先查内因(渠道入口、转化环节、人货场)；
6. 再查外因(政策、市场、竞品等)；

横向维度上的拆解或者纵向业务环节的拆分（横向的组间差异，纵向的同比环节）